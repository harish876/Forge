[job_options]
jobs = docker_test
max_workers = 5
concurrent = yes

[docker_test]
steps = extract_mssql,load_log

[lsq]
steps = extract_json,transform_lsq_col_specific,transform_lsq_projection,load_lsq,report_lsq

[lsq_shadow]
steps = extract_json,transform_lsq_col_specific,transform_lsq_projection,load_log

[talisma_insert_error_correction]
steps = extract_mssql,load_log

[extract_json]
type=extractor
filename = ./input/lsq_file.json

[extract_mssql]
type=extractor
query = SELECT top(10) tblObjectType5001.aID as talismaId, tblObjectType5001.tName as customerName, tblObjectType5001_2.FldString21895 as email, tblObjectType5001_5.FldString22796 as phone, tblObjectType5001_9.FldString24992 as utmSource, tblObjectType5001_9.FldString24993 as utmMedium, tblObjectType5001_9.FldString24994 as utmCampaign, tblObjectType5001_5.FldString22796 as userId, tblObjectType5001_1.FldString21629 as city, tblObjectType5001_2.FldString21630 as wState, (select top(1) tDisplayName from TBLENUM where nConstraintID = '10492' and nIndex = tblObjectType5001_4.FldNumeric24063 ) as state, tblObjectType5001_1.FldNumeric21615 as leadStatus, tblObjectType5001.nTeamID as team, tblObjectType5001_10.FldString25238 as bdrEmpCode, tblObjectType5001_2.FldString21666 as source, tblObjectType5001_8.FldString24270 as uccCode, tblObjectType5001_11.FldString26492 as promocode, tblObjectType5001_6.FldString22814 as leadstage1 FROM tblObjectType5001 with (nolock) LEFT JOIN tblObjectType5001_2 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_2.nID LEFT JOIN tblObjectType5001_1 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_1.nID LEFT JOIN tblObjectType5001_5 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_5.nID LEFT JOIN tblObjectType5001_9 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_9.nId LEFT JOIN tblObjectType5001_8 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_8.nId LEFT JOIN tblObjectType5001_11 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_11.nId LEFT JOIN tblObjectType5001_6 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_6.nId LEFT JOIN tblObjectType5001_10 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_10.nId LEFT JOIN tblObjectType5001_4 with (nolock) ON tblObjectType5001.aID = tblObjectType5001_4.nId WHERE (tblObjectType5001.nTeamID not in ( select aTeamID from tblTeam where tName like '%SKT%' or tName like '%STOX%' or tName like '%STX%') AND (select top(1) tDisplayName from TBLENUM where nConstraintID = '10492' and nIndex = tblObjectType5001_4.FldNumeric24063) in ('Maharashtra','Gujarat','Goa','Karnataka') OR tblObjectType5001.nTeamID in ( select aTeamID from tblTeam where tName like '%SKT%' or tName like '%STOX%' or tName like '%STX%')) AND tblObjectType5001_5.FldString22796 IS NOT NULL AND tblObjectType5001.dtCreated BETWEEN DATEADD(HOUR,${HOURS},GETDATE()) AND GETDATE()
chunk = 1000

[transform_lsq_col_specific]
type=transformer
phone_number_regex = "^\\+?[1-9]\\d{1,14}"
allowed_state_list = BLANK,, Blank Refer W-State, West Bengal, Punjab, Maharashtra, Uttar Pradesh, Gujarat,Andhra Pradesh,Telangana,Jharkhand,Kerala,Karnataka,Tripura,Mizoram,Rajasthan,Tamil Nadu,Haryana,Chattisgarh, Delhi,Jammu And Kashmir,Bihar,Madhya Pradesh,Uttarakhand,Orissa,Assam,Himachal Pradesh,Chandigarh,Daman And Diu,Nagaland,Sikkim,Manipur,Arunachal Pradesh,Puducherry,Goa,Meghalaya,Andaman And Nicobar Islands,Dadar And Nagar Haveli,Lakshwadeep,Shanghai

[transform_lsq_projection]
type=transformer
lsq_static_list = ./static/lsq_constants.json
LeadDetails1 = {"Attribute": "EmailAddress", "Column": "email"}
LeadDetails2 = {"Attribute": "Phone", "Column": "phone"}
LeadDetails3 = {"Attribute": "FirstName", "Column": "customerName"}
LeadDetails4 = {"Attribute": "SourceContent", "Column": "source"}
LeadDetails5 = {"Attribute": "mx_state", "Column": "state"}
LeadDetails6 = {"Attribute": "mx_city", "Column": "city"}
LeadDetails7 = {"Attribute": "SearchBy", "Value": "Phone"}
LeadDetails8 = {"Attribute": "__UseUserDefinedGuid__", "Value": "false"}
LeadDetails9 = {"Attribute": "mx_BdrCode", "Column": "bdrEmpCode"}
LeadDetails10 = {"Attribute": "mx_Promocode","Value": "promocode"}

OpportunityConfig1 = {"SchemaName": "OpportunityEventCode", "Value":"12000", "data_type": "int"}
OpportunityConfig2 = {"SchemaName": "OpportunityNote" , "Value": "Opportunity capture api overwrite"}
OpportunityConfig3 = {"SchemaName": "UpdateEmptyFields", "Value": "false", "data_type": "bool"}
OpportunityConfig4 = {"SchemaName": "DoNotPostDuplicateActivity", "Value": "true", "data_type": "bool"}
OpportunityConfig5 = {"SchemaName": "OverwriteFields", "Value": "false", "data_type": "bool"}
OpportunityConfig6 = {"SchemaName": "DoNotChangeOwner", "Value": "true", "data_type": "bool"}

OpportunityField1 = {"SchemaName": "mx_Custom_1", "Column": "customerName"}
OpportunityField2 = {"SchemaName": "Status", "Value": "Open"}
OpportunityField3 = {"SchemaName": "mx_Custom_2", "Value": "Active"}
OpportunityField4 = {"SchemaName": "mx_Custom_47", "Column": "state"}
OpportunityField5 = {"SchemaName": "mx_Custom_48", "Column": "city"}
OpportunityField6 = {"SchemaName": "mx_Custom_29","Column": "utmSource"}
OpportunityField7 = {"SchemaName": "mx_Custom_31","Column": "utmMedium"}
OpportunityField8 = {"SchemaName": "mx_Custom_32","Column": "utmCampaign"}
OpportunityField9 = {"SchemaName": "mx_Promocode","Column": "promocode"}
OpportunityField10 = {"SchemaName": "mx_Custom_44","Column": "talismaId"}
OpportunityField11 =  {"SchemaName": "mx_Custom_3","Column": "source"}
OpportunityField12 = {"SchemaName": "mx_Email_Id", "Column": "email"}
OpportunityField13 = {"SchemaName": "mx_Custom_60", "Column": "bdrEmpCode"}
OpportunityField14 = {"SchemaName": "mx_Custom_14", "Value": "CFS", "Fields": [{"SchemaName": "mx_CustomObject_1", "Value": "company"}, {"SchemaName": "mx_CustomObject_3", "Value": "leadType"}, {"SchemaName": "mx_CustomObject_2", "Value": "product"}, {"SchemaName": "mx_CustomObject_91", "Value": "broadProduct"}]}

[load_lsq]
type=loader
retry_count = 5
api_url=${CREATE_LEADS_ENDPOINT}

[load_log]
type=loader

[load_talisma]
type=loader
api_url=${CREATE_TALISMA_API}

[report_lsq]
type=reporter
output_folder_path = output

[lsq_test]
steps = extract_json,transform_lsq_col_specific,transform_lsq_projection,load_log

[extract_lsq_test_json]
type = extractor
filename = ./input/lsq_test.json

[transform_lsq_test_projection]
type=transformer
LeadDetails1 = {"Attribute": "EmailAddress", "Column": "email"}
LeadDetails2 = {"Attribute": "Phone", "Column": "phone"}
LeadDetails3 = {"Attribute": "FirstName", "Column": "name"}
LeadDetails4 = {"Attribute": "SourceContent", "Column": "source"}
LeadDetails5 = {"Attribute": "mx_STX_Allocation_Test","Column": "mx_STX_Allocation_Test"}
LeadDetails6 = {"Attribute": "mx_state", "Column": "state"}
LeadDetails7 = {"Attribute": "mx_city", "Column": "city"}
LeadDetails8 = {"Attribute": "SearchBy", "Value": "Phone"}
LeadDetails9 = {"Attribute": "__UseUserDefinedGuid__", "Value": "false"}
LeadDetails10 = {"Attribute": "mx_BdrCode", "Column": "referralCode"}

OpportunityConfig1 = {"SchemaName": "OpportunityEventCode", "Value":"12000", "data_type": "int"}
OpportunityConfig2 = {"SchemaName": "OpportunityNote" , "Value": "Opportunity capture api overwrite"}
OpportunityConfig3 = {"SchemaName": "UpdateEmptyFields", "Value": "false", "data_type": "bool"}
OpportunityConfig4 = {"SchemaName": "DoNotPostDuplicateActivity", "Value": "true", "data_type": "bool"}
OpportunityConfig5 = {"SchemaName": "OverwriteFields", "Value": "false", "data_type": "bool"}
OpportunityConfig6 = {"SchemaName": "DoNotChangeOwner", "Value": "true", "data_type": "bool"}

OpportunityField1 = {"SchemaName": "mx_Custom_1", "Column": "name"}
OpportunityField2 = {"SchemaName": "Status", "Value": "Open"}
OpportunityField3 = {"SchemaName": "mx_Custom_2", "Value": "Active"}
OpportunityField4 = {"SchemaName": "mx_Custom_47", "Column": "state"}
OpportunityField5 = {"SchemaName": "mx_Custom_48", "Column": "city"}
OpportunityField6 = {"SchemaName": "mx_Custom_29","Value": "google"}
OpportunityField7 = {"SchemaName": "mx_Custom_31","Value": "SourceUTM"}
OpportunityField8 = {"SchemaName": "mx_Custom_32","Value": "UTMCampaign"}
OpportunityField10 = {"SchemaName": "mx_Custom_44","Value": "153"}
OpportunityField11 =  {"SchemaName": "mx_Custom_3","Column": "source"}
OpportunityField12 = {"SchemaName": "mx_Email_Id", "Column": "email"}
OpportunityField13 = {"SchemaName": "mx_Custom_60", "Column": "referralCode"}
OpportunityField14 = {"SchemaName": "mx_Custom_14", "Value": "CFS", "Fields": [{"SchemaName": "mx_CustomObject_1", "Column": "company"}, {"SchemaName": "mx_CustomObject_3", "Column": "leadType"}, {"SchemaName": "mx_CustomObject_2", "Column": "smcProduct"}, {"SchemaName": "mx_CustomObject_91", "Column": "smcBroadProduct"}]}